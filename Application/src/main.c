/**
  ******************************************************************************
  * @file    main.c 
  * @author  Vu Trung Hieu
  * @version V1.0
  * @date    13-January-2018
  * @brief   Main program body
  ******************************************************************************
  * @attention
  *
  ******************************************************************************
  */  

/* Includes ------------------------------------------------------------------*/
#include "include.h"

/** @addtogroup GIMBAL_BLDC_NCKH
  * @{
  */

/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/
#define SVPWM_TABLE_SIZE    720
#define SPEED_CONVERT       231481.48148148150f//1000000/SVPWM_TABLE_SIZE/6*1000
/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
static const uint16_t u16_svpwm_table_A[SVPWM_TABLE_SIZE] = 
{134,130,125,121,117,113,109,105,101,97,94,90,86,83,79,76,73,70,66,63,60,57,54,52,49,46,44,41,39,36,34,32,30,28,26,24,22,20,18,17,15,14,12,11,10,9,7,6,5,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,5,5,6,7,9,10,11,12,14,15,17,18,20,22,24,26,28,30,32,34,36,39,41,44,46,49,52,54,57,60,63,66,70,73,76,79,83,86,90,94,97,101,105,109,113,117,121,125,130,134,147,160,173,187,200,214,227,241,254,268,282,295,309,323,337,351,365,379,393,407,422,436,450,465,479,493,508,522,537,551,566,581,595,610,625,640,654,669,684,699,714,729,744,759,774,789,804,819,834,849,864,879,894,909,924,939,954,969,984,999,1015,1030,1045,1060,1075,1090,1105,1120,1135,1150,1165,1180,1195,1210,1225,1240,1255,1270,1285,1300,1315,1330,1345,1359,1374,1389,1404,1418,1433,1448,1462,1477,1491,1506,1520,1534,1549,1563,1577,1592,1606,1620,1634,1648,1662,1676,1690,1704,1717,1731,1745,1758,1772,1785,1799,1812,1826,1839,1852,1865,1869,1874,1878,1882,1886,1890,1894,1898,1902,1905,1909,1913,1916,1920,1923,1926,1929,1933,1936,1939,1942,1945,1947,1950,1953,1955,1958,1960,1963,1965,1967,1969,1971,1973,1975,1977,1979,1981,1982,1984,1985,1987,1988,1989,1990,1992,1993,1994,1994,1995,1996,1997,1997,1998,1998,1998,1999,1999,1999,1999,1999,1999,1999,1998,1998,1998,1997,1997,1996,1995,1994,1994,1993,1992,1990,1989,1988,1987,1985,1984,1982,1981,1979,1977,1975,1973,1971,1969,1967,1965,1963,1960,1958,1955,1953,1950,1947,1945,1942,1939,1936,1933,1929,1926,1923,1920,1916,1913,1909,1905,1902,1898,1894,1890,1886,1882,1878,1874,1869,1865,1869,1874,1878,1882,1886,1890,1894,1898,1902,1905,1909,1913,1916,1920,1923,1926,1929,1933,1936,1939,1942,1945,1947,1950,1953,1955,1958,1960,1963,1965,1967,1969,1971,1973,1975,1977,1979,1981,1982,1984,1985,1987,1988,1989,1990,1992,1993,1994,1994,1995,1996,1997,1997,1998,1998,1998,1999,1999,1999,1999,1999,1999,1999,1998,1998,1998,1997,1997,1996,1995,1994,1994,1993,1992,1990,1989,1988,1987,1985,1984,1982,1981,1979,1977,1975,1973,1971,1969,1967,1965,1963,1960,1958,1955,1953,1950,1947,1945,1942,1939,1936,1933,1929,1926,1923,1920,1916,1913,1909,1905,1902,1898,1894,1890,1886,1882,1878,1874,1869,1865,1852,1839,1826,1812,1799,1785,1772,1758,1745,1731,1717,1704,1690,1676,1662,1648,1634,1620,1606,1592,1577,1563,1549,1534,1520,1506,1491,1477,1462,1448,1433,1418,1404,1389,1374,1359,1345,1330,1315,1300,1285,1270,1255,1240,1225,1210,1195,1180,1165,1150,1135,1120,1105,1090,1075,1060,1045,1030,1015,999,984,969,954,939,924,909,894,879,864,849,834,819,804,789,774,759,744,729,714,699,684,669,654,640,625,610,595,581,566,551,537,522,508,493,479,465,450,436,422,407,393,379,365,351,337,323,309,295,282,268,254,241,227,214,200,187,173,160,147,134,130,125,121,117,113,109,105,101,97,94,90,86,83,79,76,73,70,66,63,60,57,54,52,49,46,44,41,39,36,34,32,30,28,26,24,22,20,18,17,15,14,12,11,10,9,7,6,5,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,5,5,6,7,9,10,11,12,14,15,17,18,20,22,24,26,28,30,32,34,36,39,41,44,46,49,52,54,57,60,63,66,70,73,76,79,83,86,90,94,97,101,105,109,113,117,121,125,130};
static const uint16_t u16_svpwm_table_B[SVPWM_TABLE_SIZE] = 
{1852,1865,1869,1874,1878,1882,1886,1890,1894,1898,1902,1905,1909,1913,1916,1920,1923,1926,1929,1933,1936,1939,1942,1945,1947,1950,1953,1955,1958,1960,1963,1965,1967,1969,1971,1973,1975,1977,1979,1981,1982,1984,1985,1987,1988,1989,1990,1992,1993,1994,1994,1995,1996,1997,1997,1998,1998,1998,1999,1999,1999,1999,1999,1999,1999,1998,1998,1998,1997,1997,1996,1995,1994,1994,1993,1992,1990,1989,1988,1987,1985,1984,1982,1981,1979,1977,1975,1973,1971,1969,1967,1965,1963,1960,1958,1955,1953,1950,1947,1945,1942,1939,1936,1933,1929,1926,1923,1920,1916,1913,1909,1905,1902,1898,1894,1890,1886,1882,1878,1874,1869,1865,1869,1874,1878,1882,1886,1890,1894,1898,1902,1905,1909,1913,1916,1920,1923,1926,1929,1933,1936,1939,1942,1945,1947,1950,1953,1955,1958,1960,1963,1965,1967,1969,1971,1973,1975,1977,1979,1981,1982,1984,1985,1987,1988,1989,1990,1992,1993,1994,1994,1995,1996,1997,1997,1998,1998,1998,1999,1999,1999,1999,1999,1999,1999,1998,1998,1998,1997,1997,1996,1995,1994,1994,1993,1992,1990,1989,1988,1987,1985,1984,1982,1981,1979,1977,1975,1973,1971,1969,1967,1965,1963,1960,1958,1955,1953,1950,1947,1945,1942,1939,1936,1933,1929,1926,1923,1920,1916,1913,1909,1905,1902,1898,1894,1890,1886,1882,1878,1874,1869,1865,1852,1839,1826,1812,1799,1785,1772,1758,1745,1731,1717,1704,1690,1676,1662,1648,1634,1620,1606,1592,1577,1563,1549,1534,1520,1506,1491,1477,1462,1448,1433,1418,1404,1389,1374,1359,1345,1330,1315,1300,1285,1270,1255,1240,1225,1210,1195,1180,1165,1150,1135,1120,1105,1090,1075,1060,1045,1030,1015,999,984,969,954,939,924,909,894,879,864,849,834,819,804,789,774,759,744,729,714,699,684,669,654,640,625,610,595,581,566,551,537,522,508,493,479,465,450,436,422,407,393,379,365,351,337,323,309,295,282,268,254,241,227,214,200,187,173,160,147,134,130,125,121,117,113,109,105,101,97,94,90,86,83,79,76,73,70,66,63,60,57,54,52,49,46,44,41,39,36,34,32,30,28,26,24,22,20,18,17,15,14,12,11,10,9,7,6,5,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,5,5,6,7,9,10,11,12,14,15,17,18,20,22,24,26,28,30,32,34,36,39,41,44,46,49,52,54,57,60,63,66,70,73,76,79,83,86,90,94,97,101,105,109,113,117,121,125,130,134,130,125,121,117,113,109,105,101,97,94,90,86,83,79,76,73,70,66,63,60,57,54,52,49,46,44,41,39,36,34,32,30,28,26,24,22,20,18,17,15,14,12,11,10,9,7,6,5,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,5,5,6,7,9,10,11,12,14,15,17,18,20,22,24,26,28,30,32,34,36,39,41,44,46,49,52,54,57,60,63,66,70,73,76,79,83,86,90,94,97,101,105,109,113,117,121,125,130,134,147,160,173,187,200,214,227,241,254,268,282,295,309,323,337,351,365,379,393,407,422,436,450,465,479,493,508,522,537,551,566,581,595,610,625,640,654,669,684,699,714,729,744,759,774,789,804,819,834,849,864,879,894,909,924,939,954,969,984,999,1015,1030,1045,1060,1075,1090,1105,1120,1135,1150,1165,1180,1195,1210,1225,1240,1255,1270,1285,1300,1315,1330,1345,1359,1374,1389,1404,1418,1433,1448,1462,1477,1491,1506,1520,1534,1549,1563,1577,1592,1606,1620,1634,1648,1662,1676,1690,1704,1717,1731,1745,1758,1772,1785,1799,1812,1826,1839};
static const uint16_t u16_svpwm_table_C[SVPWM_TABLE_SIZE] = 
{1869,1865,1852,1839,1826,1812,1799,1785,1772,1758,1745,1731,1717,1704,1690,1676,1662,1648,1634,1620,1606,1592,1577,1563,1549,1534,1520,1506,1491,1477,1462,1448,1433,1418,1404,1389,1374,1359,1345,1330,1315,1300,1285,1270,1255,1240,1225,1210,1195,1180,1165,1150,1135,1120,1105,1090,1075,1060,1045,1030,1015,999,984,969,954,939,924,909,894,879,864,849,834,819,804,789,774,759,744,729,714,699,684,669,654,640,625,610,595,581,566,551,537,522,508,493,479,465,450,436,422,407,393,379,365,351,337,323,309,295,282,268,254,241,227,214,200,187,173,160,147,134,130,125,121,117,113,109,105,101,97,94,90,86,83,79,76,73,70,66,63,60,57,54,52,49,46,44,41,39,36,34,32,30,28,26,24,22,20,18,17,15,14,12,11,10,9,7,6,5,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,5,5,6,7,9,10,11,12,14,15,17,18,20,22,24,26,28,30,32,34,36,39,41,44,46,49,52,54,57,60,63,66,70,73,76,79,83,86,90,94,97,101,105,109,113,117,121,125,130,134,130,125,121,117,113,109,105,101,97,94,90,86,83,79,76,73,70,66,63,60,57,54,52,49,46,44,41,39,36,34,32,30,28,26,24,22,20,18,17,15,14,12,11,10,9,7,6,5,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,5,5,6,7,9,10,11,12,14,15,17,18,20,22,24,26,28,30,32,34,36,39,41,44,46,49,52,54,57,60,63,66,70,73,76,79,83,86,90,94,97,101,105,109,113,117,121,125,130,134,147,160,173,187,200,214,227,241,254,268,282,295,309,323,337,351,365,379,393,407,422,436,450,465,479,493,508,522,537,551,566,581,595,610,625,640,654,669,684,699,714,729,744,759,774,789,804,819,834,849,864,879,894,909,924,939,954,969,984,999,1015,1030,1045,1060,1075,1090,1105,1120,1135,1150,1165,1180,1195,1210,1225,1240,1255,1270,1285,1300,1315,1330,1345,1359,1374,1389,1404,1418,1433,1448,1462,1477,1491,1506,1520,1534,1549,1563,1577,1592,1606,1620,1634,1648,1662,1676,1690,1704,1717,1731,1745,1758,1772,1785,1799,1812,1826,1839,1852,1865,1869,1874,1878,1882,1886,1890,1894,1898,1902,1905,1909,1913,1916,1920,1923,1926,1929,1933,1936,1939,1942,1945,1947,1950,1953,1955,1958,1960,1963,1965,1967,1969,1971,1973,1975,1977,1979,1981,1982,1984,1985,1987,1988,1989,1990,1992,1993,1994,1994,1995,1996,1997,1997,1998,1998,1998,1999,1999,1999,1999,1999,1999,1999,1998,1998,1998,1997,1997,1996,1995,1994,1994,1993,1992,1990,1989,1988,1987,1985,1984,1982,1981,1979,1977,1975,1973,1971,1969,1967,1965,1963,1960,1958,1955,1953,1950,1947,1945,1942,1939,1936,1933,1929,1926,1923,1920,1916,1913,1909,1905,1902,1898,1894,1890,1886,1882,1878,1874,1869,1865,1869,1874,1878,1882,1886,1890,1894,1898,1902,1905,1909,1913,1916,1920,1923,1926,1929,1933,1936,1939,1942,1945,1947,1950,1953,1955,1958,1960,1963,1965,1967,1969,1971,1973,1975,1977,1979,1981,1982,1984,1985,1987,1988,1989,1990,1992,1993,1994,1994,1995,1996,1997,1997,1998,1998,1998,1999,1999,1999,1999,1999,1999,1999,1998,1998,1998,1997,1997,1996,1995,1994,1994,1993,1992,1990,1989,1988,1987,1985,1984,1982,1981,1979,1977,1975,1973,1971,1969,1967,1965,1963,1960,1958,1955,1953,1950,1947,1945,1942,1939,1936,1933,1929,1926,1923,1920,1916,1913,1909,1905,1902,1898,1894,1890,1886,1882,1878,1874};
volatile int32_t s32_svpwm_inc_0, s32_svpwm_idx_0;
volatile int32_t s32_svpwm_inc_1, s32_svpwm_idx_1;

/* Private function prototypes -----------------------------------------------*/
static void v_Board_Init(void);
static void v_BLDC_Ctl_Init(void);
static void v_Set_BLDC_Speed(ENUM_MOTOR_T enum_motor, int32_t s32_speed);

/* Private functions ---------------------------------------------------------*/

/**
  * @brief  Main program.
  * @param  None
  * @retval None
  */
int main(void)
{
  v_Board_Init();
  
  /* Infinite loop */
  while (1)
  {
    v_BLDC_Receive();
  }
}

/**
  * @brief  Init board
  * @param  None
  * @retval None
  */
static void v_Board_Init(void)
{
  /* Check System Clock*/
  RCC_ClocksTypeDef RCC_ClocksStructure;
  uint8_t u8_clock_source;
  u8_clock_source = RCC_GetSYSCLKSource();
  if (u8_clock_source != 0x08) // 0x08: PLL used as system clock
  {
    //while (true);
  }
  RCC_GetClocksFreq(&RCC_ClocksStructure);
  if (RCC_ClocksStructure.SYSCLK_Frequency != 72000000)
  {
    //while (true);
  }
  
  /* Enable SysTick at 1ms interrupt */
  //SysTick_Config(SystemCoreClock / F_CTRL);
  
  /* Driver Initialization */
  v_GPIO_Init();
  v_Green_On();
  
  v_Motor_Init();
  //v_PWM_Set(MOTOR_0, 0, 900, 1799);
  
  v_UART_Comm_Init();
  
  v_BLDC_Ctl_Init();
}

/**
  * @brief  BLDC Init
  * @param  None
  * @retval None
  */
static void v_BLDC_Ctl_Init(void)
{
  /* MOTOR 0 */
  s32_svpwm_inc_0 = 0;
  s32_svpwm_idx_0 = 0;
  v_PWM_Set(MOTOR_0, 0, 0, 0);
  
  /* MOTOR 1 */
  s32_svpwm_inc_1 = 0;
  s32_svpwm_idx_1 = 0;
  v_PWM_Set(MOTOR_1, 0, 0, 0);
}

/**
  * @brief  Set BLDC Speed (Hz) (x1000)
  * @param  ...
  * @param  ...
  * @retval None
  */
static void v_Set_BLDC_Speed(ENUM_MOTOR_T enum_motor, int32_t s32_speed)
{
  uint32_t u32_ts_motor;
  
  switch (enum_motor)
  {
    case MOTOR_0: 
      if (s32_speed == 0)
      {
        s32_svpwm_inc_0  = 0;
        TIM_SetAutoreload(MOTOR_0_TIM, 0xFFFF);
      }
      else
      {
        if (s32_speed > 0) s32_svpwm_inc_0 = 1;
        else
        {
          s32_speed = -s32_speed;
          s32_svpwm_inc_0 = -1;
        }
        
        /* Calculate ts in us */
        u32_ts_motor = (uint32_t)(SPEED_CONVERT / (float)s32_speed);
        if (u32_ts_motor > 0xFFFF) u32_ts_motor = 0xFFFF;
        TIM_SetAutoreload(MOTOR_0_TIM, (uint16_t)u32_ts_motor);
        if (MOTOR_0_TIM->ARR <= MOTOR_0_TIM->CNT) MOTOR_0_TIM->CNT = 0;
      }
      break;
    case MOTOR_1:
      if (s32_speed == 0)
      {
        s32_svpwm_inc_1  = 0;
        TIM_SetAutoreload(MOTOR_1_TIM, 0xFFFF);
      }
      else
      {
        if (s32_speed > 0) s32_svpwm_inc_1 = 1;
        else
        {
          s32_speed = -s32_speed;
          s32_svpwm_inc_1 = -1;
        }
        
        /* Calculate ts in us */
        u32_ts_motor = (uint32_t)(SPEED_CONVERT / (float)s32_speed);
        if (u32_ts_motor > 0xFFFF) u32_ts_motor = 0xFFFF;
        TIM_SetAutoreload(MOTOR_1_TIM, (uint16_t)u32_ts_motor);
        if (MOTOR_1_TIM->ARR <= MOTOR_1_TIM->CNT) MOTOR_1_TIM->CNT = 0;
      }
      break;
    default:
      break;
  }
}

bool bool_Set_BLDC_Speed_Handler(uint8_t u8_msg_id, uint8_t *pu8_payload, uint32_t u32_payload_cnt)
{
  int16_t s16_desired_speed;
  
  if (*pu8_payload == 0x03)
  {
    s16_desired_speed = (*(pu8_payload + 1) << 8) & 0x0ff00;
    s16_desired_speed += *(pu8_payload + 2) & 0x0ff;
    v_Set_BLDC_Speed(MOTOR_0, (int32_t)s16_desired_speed);
    
    s16_desired_speed = (*(pu8_payload + 3) << 8) & 0x0ff00;
    s16_desired_speed += *(pu8_payload + 4) & 0x0ff;
    v_Set_BLDC_Speed(MOTOR_1, (int32_t)s16_desired_speed);
  }
  else if (*pu8_payload == 0x01)
  {
    s16_desired_speed = (*(pu8_payload + 1) << 8) & 0x0ff00;
    s16_desired_speed += *(pu8_payload + 2) & 0x0ff;
    v_Set_BLDC_Speed(MOTOR_0, (int32_t)s16_desired_speed);
  }
  else if (*pu8_payload == 0x02)
  {
    s16_desired_speed = (*(pu8_payload + 3) << 8) & 0x0ff00;
    s16_desired_speed += *(pu8_payload + 4) & 0x0ff;
    v_Set_BLDC_Speed(MOTOR_1, (int32_t)s16_desired_speed);
  }
  
//  au8_respond_payload[0] = *pu8_payload;
//  au8_respond_payload[1] = 0x00; //Ok
//  v_Send_Response(u8_msg_id, au8_respond_payload, 2);
  v_Red_Toggle();
  return true;
}

void MOTOR_0_TIMER_IRQ_Handler(void)
{
  if (TIM_GetITStatus(MOTOR_0_TIM, TIM_IT_Update) != RESET)
  {
    TIM_ClearITPendingBit(MOTOR_0_TIM, 0xFF);
    
    if (s32_svpwm_inc_0 != 0) // if need shift voltage
    {
      /* Increase index 0 with s32_svpwm_inc_0 */
      s32_svpwm_idx_0 += s32_svpwm_inc_0;
      if (s32_svpwm_idx_0 >= SVPWM_TABLE_SIZE) s32_svpwm_idx_0 = 0;
      else if (s32_svpwm_idx_0 < 0) s32_svpwm_idx_0 = SVPWM_TABLE_SIZE - 1;
      
      /* Write desired pwm */
      v_PWM_Set(MOTOR_0, u16_svpwm_table_A[s32_svpwm_idx_0], 
                u16_svpwm_table_B[s32_svpwm_idx_0], u16_svpwm_table_C[s32_svpwm_idx_0]);
    }
  }
}

void MOTOR_1_TIMER_IRQ_Handler(void)
{
  if (TIM_GetITStatus(MOTOR_1_TIM, TIM_IT_Update) != RESET)
  {
    TIM_ClearITPendingBit(MOTOR_1_TIM, TIM_IT_Update);
    
    if (s32_svpwm_inc_1 != 0) // if need shift voltage
    {
      /* Increase index 1 with s32_svpwm_inc_1 */
      s32_svpwm_idx_1 += s32_svpwm_inc_1;
      if (s32_svpwm_idx_1 >= SVPWM_TABLE_SIZE) s32_svpwm_idx_1 = 0;
      else if (s32_svpwm_idx_1 < 0) s32_svpwm_idx_1 = SVPWM_TABLE_SIZE - 1;
      
      /* Write desired pwm */
      v_PWM_Set(MOTOR_1, u16_svpwm_table_A[s32_svpwm_idx_1], 
                u16_svpwm_table_B[s32_svpwm_idx_1], u16_svpwm_table_C[s32_svpwm_idx_1]);
    }
  }
}

#ifdef  USE_FULL_ASSERT

/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t* file, uint32_t line)
{ 
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */

  /* Infinite loop */
  while (1)
  {
    
  }
}
#endif

/**
  * @}
  */


/******************* (C) COPYRIGHT 2011 STMicroelectronics *****END OF FILE****/
